<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backpack Filler Prototype Avancé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6; /* Light background */
            color: #333;
            margin: 0; /* Remove default body margin */
            padding: 0;
            display: flex; /* Use flexbox for layout */
            min-height: 100vh; /* Minimum height of the viewport */
        }
        .sidebar {
            width: 250px; /* Fixed width sidebar */
            background-color: #e9ecef; /* Light sidebar background */
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .sidebar h2 {
            color: #005f73;
            margin-bottom: 20px;
            text-align: center;
        }
        .sidebar nav ul {
            list-style: none;
            padding: 0;
        }
        .sidebar nav ul li {
            margin-bottom: 10px;
        }
        .sidebar nav ul li a {
            display: flex; /* Use flex for icon and text alignment */
            align-items: center;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px; /* Rounded corners for menu items */
            transition: background-color 0.3s ease;
        }
         .sidebar nav ul li a i {
             margin-right: 10px; /* Space between icon and text */
         }
        .sidebar nav ul li a:hover {
            background-color: #d0d4d8; /* Slightly darker on hover */
        }
        .sidebar nav ul li a.active {
            background-color: #0077b6; /* Active item background */
            color: white;
        }
         .sidebar nav ul li a.active .menu-weight {
             color: rgba(255, 255, 255, 0.8); /* Lighter weight text in active state */
         }

        .main-content {
            flex-grow: 1; /* Main content takes remaining space */
            padding: 20px;
            overflow-y: auto; /* Enable scrolling if content overflows */
        }
        .content-section {
             background-color: #fff;
             padding: 30px;
             border-radius: 15px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
             margin-bottom: 20px; /* Add margin between sections if multiple are visible (though we will hide them) */
        }

        h1 {
            color: #005f73; /* A clean blue */
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #0077b6; /* A vibrant blue */
            margin-bottom: 15px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
         h3 {
            color: #023e8a; /* Darker blue */
            margin-top: 20px;
            margin-bottom: 10px;
        }
        /* --- Form Styling --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Adjusted grid for form */
            gap: 20px; /* Increased gap */
            margin-bottom: 20px;
        }
         .form-group {
             display: flex;
             flex-direction: column; /* Stack label and input */
         }
         .form-group label {
             margin-bottom: 5px;
             font-weight: 600;
             color: #555;
         }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group select {
            width: 100%;
            padding: 12px; /* Increased padding */
            border: 1px solid #ccc;
            border-radius: 8px; /* More rounded corners */
            font-size: 1rem;
             transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
         .form-group input[type="text"]:focus,
         .form-group input[type="number"]:focus,
         .form-group input[type="url"]:focus,
         .form-group select:focus {
             border-color: #0077b6; /* Highlight on focus */
             box-shadow: 0 0 5px rgba(0, 119, 182, 0.3);
             outline: none; /* Remove default outline */
         }

         .checkbox-group {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-top: 10px; /* Space above checkbox */
         }
         .checkbox-group input[type="checkbox"] {
             width: 20px;
             height: 20px;
             cursor: pointer;
             border-radius: 4px;
             border: 1px solid #ccc;
             appearance: none; /* Hide default checkbox */
             -webkit-appearance: none;
             -moz-appearance: none;
             position: relative;
             transition: background-color 0.3s ease, border-color 0.3s ease;
         }
         .checkbox-group input[type="checkbox"]:checked {
             background-color: #06d6a0; /* Green when checked */
             border-color: #06d6a0;
         }
          .checkbox-group input[type="checkbox"]:checked::after {
             content: '\2713'; /* Checkmark symbol */
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             color: white;
             font-size: 14px;
             font-weight: bold;
          }

        .form-button {
            width: auto; /* Button width based on content */
            padding: 12px 25px; /* Increased padding */
            background-color: #0077b6; /* A vibrant blue */
            color: white;
            border: none;
            border-radius: 8px; /* More rounded corners */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-size: 1.1rem;
            font-weight: 600;
            display: block; /* Make button a block element for full width on small screens */
            margin-top: 20px; /* Space above the button */
        }
         @media (min-width: 640px) {
             .form-button {
                 display: inline-block; /* Back to inline-block on larger screens */
             }
         }


        .form-button:hover {
            background-color: #023e8a; /* Darker blue on hover */
        }
         .form-button:active {
             transform: scale(0.98); /* Slightly shrink on click */
         }

        /* --- Existing Styles --- */
        .input-group { /* Generic input group style */
             display: flex;
             gap: 15px;
             margin-bottom: 15px;
        }
        .input-group input[type="text"] {
             flex-grow: 1;
             padding: 10px;
             border: 1px solid #ccc;
             border-radius: 5px;
             font-size: 1rem;
        }
         .input-group button {
             padding: 10px 20px;
             background-color: #00b4d8; /* Cyan */
             color: white;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             transition: background-color 0.3s ease;
         }
         .input-group button:hover {
             background-color: #48cae4; /* Lighter cyan on hover */
         }


        .item-list, .pack-list, .category-list {
            list-style: none;
            padding: 0;
        }
        .item, .pack-item, .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px; /* Increased padding for better bar visibility */
            border-bottom: 1px solid #ccc;
            position: relative; /* Needed for absolute positioning of bar graph */
             overflow: hidden; /* Hide overflow from bar graph */
             min-height: 40px; /* Ensure minimum height for bar */
        }
        .item:last-child, .pack-item:last-child, .category-item:last-child {
            border-bottom: none;
        }

        .item-details, .pack-details, .category-details {
            flex-grow: 1;
            margin-right: 15px;
            z-index: 1; /* Ensure details are above the bar graph */
            /* Removed semi-transparent background */
            /* Removed padding-right */
             display: flex; /* Use flexbox for details to align image */
             align-items: center; /* Vertically center items */
        }
        .item-details img {
            margin-right: 10px; /* Space between image and text */
        }

        .item-name, .pack-name, .category-name {
            font-weight: 600;
        }
        .item-weight, .pack-weight, .category-weight {
            font-size: 0.9rem;
            color: #555;
        }
         .item-brand, .item-category, .item-tags, .item-capacity, .item-consumable {
             font-size: 0.8rem;
             color: #666;
             margin-left: 5px;
         }
        .item-actions, .pack-actions, .category-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 1; /* Ensure actions are above the bar graph */
            /* Removed semi-transparent background */
            /* Removed padding-left */
        }
        .item-actions button, .pack-actions button, .category-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .pack-button {
            background-color: #00b4d8; /* Cyan */
            color: white;
        }
        .pack-button:hover {
            background-color: #48cae4; /* Lighter cyan on hover */
        }
        .packed .pack-button {
            background-color: #06d6a0; /* Green when packed */
        }
        .packed .pack-button:hover {
             background-color: #80ed99; /* Lighter green on hover */
        }
        .delete-button {
            background-color: #ef476f; /* Red */
            color: white;
        }
        .delete-button:hover {
            background-color: #ff7096; /* Lighter red on hover */
        }
         .edit-button {
             background-color: #ffb703; /* Yellow/Orange */
             color: white;
         }
         .edit-button:hover {
             background-color: #ffc300; /* Lighter yellow/orange on hover */
         }
        .view-pack-button, .view-category-button {
             background-color: #90e0ef; /* Light blue */
             color: #023e8a;
        }
         .view-pack-button:hover, .view-category-button:hover {
             background-color: #ade8f4;
         }

        .total-weight {
            text-align: right;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ccc;
        }
        .packed-status {
            font-size: 0.9rem;
            color: #06d6a0; /* Green */
            font-weight: 600;
        }
         .not-packed-status {
            font-size: 0.9rem;
            color: #ef476f; /* Red */
            font-weight: 600;
        }

        /* --- Improved Weight Bar Styling --- */
        .weight-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            /* Use a subtle gradient */
            background: linear-gradient(to right, rgba(0, 119, 182, 0.1), rgba(0, 119, 182, 0.3));
            width: 0%; /* Will be set by JS */
            z-index: 0; /* Behind the content */
            transition: width 0.5s ease-in-out;
            border-radius: 8px; /* Rounded corners for the bar */
        }

         /* Style for packed items/packs/categories */
         .packed .weight-bar {
             background: linear-gradient(to right, rgba(6, 214, 160, 0.1), rgba(6, 214, 160, 0.3)); /* Green gradient for packed */
         }


        .pack-packing-view {
            margin-top: 20px;
            padding: 15px;
            background-color: #caf0f8; /* Lighter blue background */
            border-radius: 8px;
            border: 1px dashed #00b4d8;
        }
        .pack-packing-view h3 {
            margin-top: 0;
            border-bottom: 1px dashed #00b4d8;
            padding-bottom: 5px;
        }
        .pack-packing-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dotted #90e0ef;
        }
        .pack-packing-item:last-child {
            border-bottom: none;
        }
        .pack-packing-item .item-name {
            flex-grow: 1;
            margin-right: 10px;
        }
        .pack-packing-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

         /* Hide content sections by default, show only the active one */
         .content-section {
             display: none;
         }
         .content-section.active {
             display: block;
         }

         .menu-weight {
             margin-left: auto; /* Push weight to the right */
             font-size: 0.9rem;
             color: #555;
         }

          /* Responsive adjustments */
         @media (max-width: 768px) {
             body {
                 flex-direction: column; /* Stack sidebar and content on small screens */
             }
             .sidebar {
                 width: 100%; /* Full width sidebar on small screens */
                 height: auto; /* Height adjusts to content */
                 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
             }
             .sidebar nav ul {
                 display: flex; /* Arrange menu items in a row */
                 flex-wrap: wrap; /* Allow wrapping */
                 justify-content: center; /* Center menu items */
                 gap: 10px; /* Add space between menu items */
             }
             .sidebar nav ul li {
                 margin-bottom: 0; /* Remove bottom margin */
             }
             .sidebar nav ul li a {
                 padding: 8px 12px; /* Adjust padding */
                 flex-direction: column; /* Stack icon and text */
                 text-align: center;
             }
             .sidebar nav ul li a i {
                 margin-right: 0;
                 margin-bottom: 5px; /* Space between icon and text */
             }
             .menu-weight {
                 margin-left: 0; /* Remove auto margin */
                 margin-top: 5px; /* Add space above weight */
             }
             .main-content {
                 padding: 15px; /* Adjust padding */
             }
             .content-section {
                 padding: 20px; /* Adjust padding */
             }
         }


         /* Modal styles */
         .modal {
             display: none; /* Hidden by default */
             position: fixed; /* Stay in place */
             z-index: 100; /* Sit on top */
             left: 0;
             top: 0;
             width: 100%; /* Full width */
             height: 100%; /* Full height */
             overflow: auto; /* Enable scroll if needed */
             background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
         }

         .modal-content {
             background-color: #fefefe;
             margin: 10% auto; /* 10% from the top and centered */
             padding: 20px;
             border: 1px solid #888;
             width: 80%; /* Could be more or less, depending on screen size */
             max-width: 600px; /* Max width for larger screens */
             border-radius: 10px;
             box-shadow: 0 5px 15px rgba(0,0,0,0.3);
         }

         .close-button {
             color: #aaa;
             float: right;
             font-size: 28px;
             font-weight: bold;
         }

         .close-button:hover,
         .close-button:focus {
             color: #000;
             text-decoration: none;
             cursor: pointer;
         }

        /* --- Pack Detail Page Styles --- */
        .pack-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns */
            gap: 30px; /* Space between columns */
        }

        .pack-detail-column h3 {
            margin-top: 0;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        .pack-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px; /* Adjusted padding for bar */
            border-bottom: 1px dotted #eee;
            position: relative; /* Needed for absolute positioning of bar graph */
            overflow: hidden; /* Hide overflow from bar graph */
            min-height: 40px; /* Ensure minimum height for bar */
        }
         .pack-detail-item:last-child {
             border-bottom: none;
         }

        .pack-detail-item-name {
            flex-grow: 1;
            margin-right: 10px;
            z-index: 1; /* Ensure details are above the bar graph */
        }

        .pack-detail-actions {
             display: flex;
             gap: 5px; /* Space between buttons */
             align-items: center;
             z-index: 1; /* Ensure actions are above the bar graph */
        }

        .pack-detail-actions button {
             padding: 5px 10px;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             transition: background-color 0.3s ease;
        }

        .add-to-pack-button {
             background-color: #06d6a0; /* Green */
             color: white;
        }
         .add-to-pack-button:hover {
             background-color: #80ed99; /* Lighter green */
         }

        .remove-from-pack-button {
             background-color: #ef476f; /* Red */
             color: white;
        }
         .remove-from-pack-button:hover {
             background-color: #ff7096; /* Lighter red */
         }

         .pack-item-packed-button {
             background-color: #00b4d8; /* Cyan */
             color: white;
         }
         .pack-item-packed-button:hover {
             background-color: #48cae4; /* Lighter cyan on hover */
         }
         .pack-detail-item.packed .pack-item-packed-button {
             background-color: #06d6a0; /* Green when packed */
         }
         .pack-detail-item.packed .pack-item-packed-button:hover {
             background-color: #80ed99; /* Lighter green on hover */
         }

        .unpack-all-button {
            background-color: #ffb703; /* Yellow/Orange */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 20px; /* Space below button */
        }
         .unpack-all-button:hover {
             background-color: #ffc300; /* Lighter yellow/orange */
         }

        /* Category Management Styles */
        .category-management-list .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            background-color: #e9ecef; /* Light background for category header */
            border-bottom: 1px solid #ccc;
            font-weight: 600;
            cursor: pointer; /* Indicate clickable */
            border-radius: 8px;
            margin-bottom: 5px;
        }
        .category-management-list .category-header:hover {
            background-color: #d0d4d8;
        }
        .category-management-list .category-content {
            display: none; /* Hidden by default */
            padding-left: 20px; /* Indent items */
            border-left: 2px solid #0077b6; /* Visual indicator */
            margin-bottom: 10px;
        }
        .category-management-list .category-content.is-visible {
            display: block;
        }
         .category-management-list .category-content .item {
             padding: 8px 0; /* Smaller padding for items within category */
             border-bottom: 1px dotted #eee;
         }
         .category-management-list .category-content .item:last-child {
             border-bottom: none;
         }
         .category-management-list .category-header .category-name {
             flex-grow: 1;
         }
         .category-management-list .category-header .category-item-count {
             font-size: 0.9rem;
             color: #555;
         }

        /* Styles for LLM features */
        .llm-button {
             background-color: #6a0572; /* Deep purple */
             color: white;
             padding: 8px 15px;
             border: none;
             border-radius: 8px;
             cursor: pointer;
             transition: background-color 0.3s ease, transform 0.1s ease;
             font-size: 0.9rem;
             font-weight: 600;
             margin-top: 10px;
             margin-right: 10px; /* Space between buttons */
         }
         .llm-button:hover {
             background-color: #92209d; /* Lighter purple on hover */
         }
         .llm-button:active {
             transform: scale(0.98);
         }
         .llm-loading-indicator {
             margin-left: 10px;
             font-style: italic;
             color: #6a0572;
         }

        #generate-pack-modal {
            display: none;
        }
        #generated-items-list li {
            background-color: #f8f8f8;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         #generated-items-list li .item-name {
             font-weight: bold;
         }
         #generated-items-list li .item-details {
             font-size: 0.9em;
             color: #555;
         }
         #generated-items-list li button {
             padding: 5px 10px;
             background-color: #06d6a0;
             color: white;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             transition: background-color 0.3s ease;
         }
         #generated-items-list li button:hover {
             background-color: #80ed99;
         }

        /* Explicitly ensure form elements are visible within generate-pack-section */
        #generate-pack-section .form-grid {
            display: grid !important; /* Force grid display for the container */
            visibility: visible !important;
            opacity: 1 !important;
        }

        #generate-pack-section .form-group {
            display: flex !important; /* Force flex display for each form group */
            visibility: visible !important;
            opacity: 1 !important;
        }

        #generate-pack-section input[type="text"],
        #generate-pack-section input[type="number"] {
            display: block !important; /* Force block display for inputs */
            visibility: visible !important;
            opacity: 1 !important;
        }

        #generate-pack-section button#generate-pack-list-button {
            display: inline-block !important; /* Force inline-block for the button */
            visibility: visible !important;
            opacity: 1 !important;
        }

        .item-suggestion.existing-item {
            background-color: #e0f2f7; /* Light blue for existing items */
            border: 1px solid #0077b6;
        }

        .item-suggestion.existing-item .add-generated-item-checkbox {
            display: none; /* Hide checkbox for existing items */
        }


        @media (max-width: 768px) {
             .pack-detail-grid {
                 grid-template-columns: 1fr; /* Stack columns on small screens */
             }
        }

        .image-preview {
            width: 80px; /* Adjust size as needed */
            height: 80px; /* Adjust size as needed */
            border-radius: 8px; /* Rounded corners for preview */
            object-fit: cover; /* Cover the area */
            border: 1px solid #ddd;
            margin-top: 10px; /* Space below input */
            display: block; /* Ensure it takes its own line */
            background-color: #f0f0f0; /* Light background for empty/broken image */
        }


    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Backpack Filler</h2>
        <nav>
            <ul>
                <li><a href="#inventory" class="active" data-section="inventory"><i class="fas fa-boxes"></i> Mon Inventaire <span id="inventory-weight" class="menu-weight"></span></a></li>
                <li><a href="#new-item" data-section="new-item"><i class="fas fa-plus-circle"></i> Ajouter un Item</a></li>
                <li><a href="#manage-packs" data-section="manage-packs"><i class="fas fa-suitcase"></i> Packs</a></li>
                 <li><a href="#manage-categories" data-section="manage-categories"><i class="fas fa-tags"></i> Catégories</a></li>
                 <li><a href="#generate-pack-section" data-section="generate-pack"><i class="fas fa-magic"></i> Générer un Pack ✨</a></li>
            </ul>
        </nav>
         </div>

    <div class="main-content">
        <div id="inventory-section" class="content-section active">
            <h2>Mon Inventaire</h2>
             <select id="view-filter" class="mb-4 p-2 border rounded">
                 <option value="all">Voir tout</option>
                 <option value="categories">Voir par Catégorie</option>
                 </select>
            <ul id="item-list" class="item-list">
                </ul>
            <div id="total-weight" class="total-weight">
                Poids Total : 0 g
            </div>
        </div>

        <div id="new-item-section" class="content-section">
            <h2>Ajouter un Nouvel Item</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="item-name">Nom de l'item</label>
                    <input type="text" id="item-name" placeholder="Ex: Tente 2 places">
                </div>
                <div class="form-group">
                     <label for="item-weight">Poids (g)</label>
                    <input type="number" id="item-weight" placeholder="Ex: 1500" min="0">
                </div>
                <div class="form-group">
                    <label for="item-brand">Marque</label>
                    <input type="text" id="item-brand" placeholder="Ex: Decathlon">
                </div>
                <div class="form-group">
                    <label for="item-category">Catégorie</label>
                    <select id="item-category"> <option value="">-- Sélectionner une Catégorie --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-tags">Tags (séparés par virgule)</label>
                    <input type="text" id="item-tags" placeholder="Ex: bivouac, léger">
                </div>
                <div class="form-group">
                    <label for="item-capacity">Capacité/Volume</label>
                    <input type="text" id="item-capacity" placeholder="Ex: 2 personnes / 15L">
                </div>
                <div class="form-group">
                    <label for="item-image-url">URL Image (optionnel)</label>
                    <input type="url" id="item-image-url" placeholder="Ex: https://example.com/tente.jpg">
                    <img id="new-item-image-preview" class="image-preview" src="https://placehold.co/80x80/eeeeee/aaaaaa?text=Image" alt="Aperçu image" style="display: none;">
                </div>
                 <div class="checkbox-group">
                     <input type="checkbox" id="item-consumable">
                     <label for="item-consumable">Consommable</label>
                 </div>
            </div>
            <button id="suggest-new-item-details-button" class="llm-button">Suggérer Détails Item ✨</button>
            <button id="add-item-button" class="form-button">Ajouter Item</button>
            <span id="new-item-loading-indicator" class="llm-loading-indicator hidden">Chargement...</span>
        </div>

         <div id="manage-packs-section" class="content-section">
            <h2>Gérer les Packs</h2>
            <div class="input-group"> <input type="text" id="pack-name" placeholder="Nom du nouveau Pack">
                <button id="add-pack-button">Créer Pack</button>
            </div>
            <h3>Liste des Packs</h3>
            <ul id="pack-list" class="pack-list">
                </ul>
         </div>

         <div id="pack-detail-section" class="content-section">
             <h2 id="pack-detail-title">Détails du Pack : </h2>
             <button id="unpack-all-button" class="unpack-all-button">Tout Déballer ce Pack</button> <div class="pack-detail-grid">
                 <div class="pack-detail-column">
                     <h3>Items dans ce Pack</h3>
                     <ul id="items-in-pack-list">
                         </ul>
                 </div>
                 <div class="pack-detail-column">
                     <h3>Items disponibles</h3>
                     <ul id="available-items-list">
                         </ul>
                 </div>
             </div>
         </div>

         <div id="manage-categories-section" class="content-section">
             <h2>Gérer les Catégories</h2>
             <div class="input-group"> <input type="text" id="category-name" placeholder="Nom de la nouvelle Catégorie">
                 <button id="add-category-button">Créer Catégorie</button>
             </div>
             <p class="text-gray-600 mb-4">Cliquez sur une catégorie pour voir les items associés.</p>
             <ul id="category-management-list" class="category-management-list">
                 </ul>
         </div>

         <div id="generate-pack-section" class="content-section">
             <h2>Générer une Liste de Pack ✨</h2>
             <div class="form-grid">
                 <div class="form-group">
                     <label for="gen-pack-destination">Destination (lieu ou type de terrain)</label>
                     <input type="text" id="gen-pack-destination" placeholder="Ex: Montagnes, Forêt, Ville">
                 </div>
                 <div class="form-group">
                     <label for="gen-pack-duration">Durée (en jours)</label>
                     <input type="number" id="gen-pack-duration" min="1" value="3">
                 </div>
                 <div class="form-group">
                     <label for="gen-pack-activity">Activité principale</label>
                     <input type="text" id="gen-pack-activity" placeholder="Ex: Randonnée, Camping, Ski, Voyage">
                 </div>
             </div>
             <button id="generate-pack-list-button" class="llm-button">Générer Suggestions ✨</button>
             <span id="generate-pack-loading-indicator" class="llm-loading-indicator hidden">Génération en cours...</span>

             <div id="generated-pack-results" class="mt-8"> <!-- Removed hidden class -->
                 <h3>Suggestions d'Items</h3>
                 <ul id="generated-items-list" class="item-list">
                     <!-- Generated items will be inserted here -->
                     <li class="text-center text-gray-500">Aucune suggestion d'item générée. Veuillez utiliser le formulaire ci-dessus.</li>
                 </ul>
                 <button id="add-selected-generated-items-button" class="form-button mt-4">Ajouter les items sélectionnés à l'inventaire</button>
             </div>
         </div>


         <div id="pack-packing-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
             <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                 <div class="mt-3 text-center">
                     <h3 class="text-lg leading-6 font-medium text-gray-900" id="packing-pack-name">Emballage du Pack : </h3>
                     <div class="mt-2 px-7 py-3">
                         <ul id="pack-packing-list">
                             </ul>
                     </div>
                     <div class="items-center px-4 py-3">
                         <button id="close-packing-modal" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus::ring-blue-500">
                             Fermer
                         </button>
                     </div>
                 </div>
             </div>
         </div>

         <div id="edit-item-modal" class="modal">
             <div class="modal-content">
                 <span class="close-button" id="close-edit-modal">&times;</span>
                 <h2>Modifier Item</h2>
                  <div class="form-grid">
                     <div class="form-group">
                         <label for="edit-item-name">Nom de l'item</label>
                         <input type="text" id="edit-item-name">
                     </div>
                     <div class="form-group">
                          <label for="edit-item-weight">Poids (g)</label>
                         <input type="number" id="edit-item-weight" min="0">
                     </div>
                     <div class="form-group">
                         <label for="edit-item-brand">Marque</label>
                         <input type="text" id="edit-item-brand">
                     </div>
                     <div class="form-group">
                         <label for="edit-item-category">Catégorie</label>
                         <select id="edit-item-category"> <option value="">-- Sélectionner une Catégorie --</option>
                         </select>
                     </div>
                     <div class="form-group">
                         <label for="edit-item-tags">Tags (séparés par virgule)</label>
                         <input type="text" id="edit-item-tags">
                     </div>
                     <div class="form-group">
                         <label for="edit-item-capacity">Capacité/Volume</label>
                         <input type="text" id="edit-item-capacity">
                     </div>
                     <div class="form-group">
                         <label for="edit-item-image-url">URL Image (optionnel)</label>
                         <input type="url" id="edit-item-image-url">
                         <img id="edit-item-image-preview" class="image-preview" src="https://placehold.co/80x80/eeeeee/aaaaaa?text=Image" alt="Aperçu image" style="display: none;">
                     </div>
                      <div class="checkbox-group">
                          <input type="checkbox" id="edit-item-consumable">
                          <label for="edit-item-consumable">Consommable</label>
                      </div>
                 </div>
                 <button id="suggest-edit-item-details-button" class="llm-button">Suggérer Détails Item ✨</button>
                 <button id="save-item-button" class="form-button">Enregistrer les modifications</button>
                 <span id="edit-item-loading-indicator" class="llm-loading-indicator hidden">Chargement...</span>
                 <input type="hidden" id="editing-item-id">
             </div>
         </div>


    </div>

    <script>
        // Get references to HTML elements (Add Item Section)
        const newItemNameInput = document.getElementById('item-name');
        const newItemWeightInput = document.getElementById('item-weight');
        const newItemBrandInput = document.getElementById('item-brand');
        const newItemCategorySelect = document.getElementById('item-category'); // Changed to select
        const newItemTagsInput = document.getElementById('item-tags');
        const newItemCapacityInput = document.getElementById('item-capacity');
        const newItemImageUrlInput = document.getElementById('item-image-url');
        const newItemConsumableInput = document.getElementById('item-consumable');
        const newItemImagePreview = document.getElementById('new-item-image-preview'); // New: Image preview for new item
        const addItemButton = document.getElementById('add-item-button');
        const suggestNewItemDetailsButton = document.getElementById('suggest-new-item-details-button');
        const newItemLoadingIndicator = document.getElementById('new-item-loading-indicator');


        // Get references to HTML elements (Manage Packs Section)
        const packNameInput = document.getElementById('pack-name');
        const addPackButton = document.getElementById('add-pack-button');
        const packListElement = document.getElementById('pack-list');

        // Get references to HTML elements (Inventory Section)
        const itemListElement = document.getElementById('item-list');
        const totalWeightElement = document.getElementById('total-weight');
        const viewFilterSelect = document.getElementById('view-filter');

         // Get references to HTML elements (Category Management Section)
         const categoryNameInput = document.getElementById('category-name'); // New category input
         const addCategoryButton = document.getElementById('add-category-button'); // New category button
         const categoryManagementListElement = document.getElementById('category-management-list');


        // Get references to HTML elements (Pack Packing Modal)
        const packPackingModal = document.getElementById('pack-packing-modal');
        const packingPackNameElement = document.getElementById('packing-pack-name');
        const packPackingListElement = document.getElementById('pack-packing-list'); // Corrected assignment
        const closePackingModalButton = document.getElementById('close-packing-modal');

        // Get references to HTML elements (Edit Item Modal)
        const editItemModal = document.getElementById('edit-item-modal');
        const editItemNameInput = document.getElementById('edit-item-name');
        const editItemWeightInput = document.getElementById('edit-item-weight');
        const editItemBrandInput = document.getElementById('edit-item-brand');
        const editItemCategorySelect = document.getElementById('edit-item-category'); // Changed to select
        const editItemTagsInput = document.getElementById('edit-item-tags'); // Corrected ID
        const editItemCapacityInput = document.getElementById('edit-item-capacity');
        const editItemImageUrlInput = document.getElementById('edit-item-image-url');
        const editItemConsumableInput = document.getElementById('edit-item-consumable');
        const editItemImagePreview = document.getElementById('edit-item-image-preview'); // New: Image preview for edit item
        const saveItemButton = document.getElementById('save-item-button');
        const editingItemIdInput = document.getElementById('editing-item-id');
        const closeEditModalButton = document.getElementById('close-edit-modal');
        const suggestEditItemDetailsButton = document.getElementById('suggest-edit-item-details-button');
        const editItemLoadingIndicator = document.getElementById('edit-item-loading-indicator');


        // Get references to HTML elements (Pack Detail Section)
        const packDetailSection = document.getElementById('pack-detail-section');
        const packDetailTitle = document.getElementById('pack-detail-title');
        const itemsInPackList = document.getElementById('items-in-pack-list');
        const availableItemsList = document.getElementById('available-items-list');
        const unpackAllButton = document.getElementById('unpack-all-button'); // New button reference

        // Get references to HTML elements (Sidebar and Layout)
        const sidebarLinks = document.querySelectorAll('.sidebar nav ul li a');
        const contentSections = document.querySelectorAll('.main-content .content-section');
        const inventoryWeightElement = document.getElementById('inventory-weight');

        // Get references to HTML elements (Generate Pack Section)
        const genPackDestinationInput = document.getElementById('gen-pack-destination');
        const genPackDurationInput = document.getElementById('gen-pack-duration');
        const genPackActivityInput = document.getElementById('gen-pack-activity');
        const generatePackListButton = document.getElementById('generate-pack-list-button');
        const generatePackLoadingIndicator = document.getElementById('generate-pack-loading-indicator');
        const generatedPackResultsDiv = document.getElementById('generated-pack-results');
        const generatedItemsListElement = document.getElementById('generated-items-list');
        const addSelectedGeneratedItemsButton = document.getElementById('add-selected-generated-items-button');


        // Arrays to store items, packs, and explicitly created categories
        let items = [];
        let packs = []; // [{ id: 'pack-id-1', name: 'Nom du Pack' }]
        let categories = []; // New array for explicitly created categories [{ name: 'Nom Catégorie' }]
        let currentView = 'all'; // 'all', 'categories', 'pack-{packId}'
        let currentManagingPackId = null; // Store the ID of the pack being managed

        // Function to save data to local storage
        function saveData() {
            localStorage.setItem('backpackItems', JSON.stringify(items));
            localStorage.setItem('backpackPacks', JSON.stringify(packs));
            localStorage.setItem('backpackCategories', JSON.stringify(categories)); // Save categories
        }

        // Function to load data from local storage
        function loadData() {
            const storedItems = localStorage.getItem('backpackItems');
            const storedPacks = localStorage.getItem('backpackPacks');
            const storedCategories = localStorage.getItem('backpackCategories'); // Load categories

            if (storedItems && JSON.parse(storedItems).length > 0) { // Check if items exist and are not empty
                items = JSON.parse(storedItems);
                 // Ensure packIds is an array for older data
                 items.forEach(item => {
                     if (!item.packIds) {
                         item.packIds = item.packId ? [item.packId] : [];
                         delete item.packId; // Remove old property
                     }
                 });
            } else {
                // Pre-fill with example data if no items are found
                items = [
                    { id: 'item-1', name: 'Tente 2P MSR Hubba Hubba', weight: 1300, brand: 'MSR', category: 'Camping', tags: ['bivouac', 'léger'], capacity: '2 personnes', imageUrl: 'https://placehold.co/50x50/aabbcc/ffffff?text=Tente', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-2', name: 'Sac de couchage -5°C', weight: 900, brand: 'Decathlon', category: 'Camping', tags: ['chaud'], capacity: 'N/A', imageUrl: 'https://placehold.co/50x50/ccbbaa/ffffff?text=Couchage', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-3', name: 'Réchaud à gaz MSR PocketRocket', weight: 73, brand: 'MSR', category: 'Cuisine', tags: ['léger', 'gaz'], capacity: 'N/A', imageUrl: 'https://placehold.co/50x50/aaccee/ffffff?text=Réchaud', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-4', name: 'Popote Titane 750ml', weight: 130, brand: 'Evernew', category: 'Cuisine', tags: ['ultralight'], capacity: '750ml', imageUrl: 'https://placehold.co/50x50/eeddcc/ffffff?text=Popote', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-5', name: 'Veste Pluie Gore-Tex', weight: 350, brand: 'Arc\'teryx', category: 'Vêtements', tags: ['imperméable'], capacity: 'N/A', imageUrl: 'https://placehold.co/50x50/ffccaa/ffffff?text=Veste', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-6', name: 'Frontale Petzl Bindi', weight: 35, brand: 'Petzl', category: 'Électronique', tags: ['lumière', 'usb'], capacity: 'N/A', imageUrl: 'https://placehold.co/50x50/ddeeff/ffffff?text=Frontale', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-7', name: 'Crème solaire SPF50', weight: 80, brand: 'La Roche-Posay', category: 'Hygiène', tags: ['protection', 'soleil'], capacity: '50ml', imageUrl: 'https://placehold.co/50x50/ffeebb/ffffff?text=Solaire', isConsumable: true, packIds: [], packed: false },
                    { id: 'item-8', name: 'Kit Premiers Secours', weight: 150, brand: 'Adventure Medical Kits', category: 'Sécurité', tags: ['urgence', 'médical'], capacity: 'N/A', imageUrl: 'https://placehold.co/50x50/cceeff/ffffff?text=Trousse', isConsumable: false, packIds: [], packed: false },
                    { id: 'item-9', name: 'Barres énergétiques', weight: 200, brand: 'Isostar', category: 'Nourriture', tags: ['snack', 'énergie'], capacity: '4 barres', imageUrl: 'https://placehold.co/50x50/ccffdd/ffffff?text=Barres', isConsumable: true, packIds: [], packed: false },
                    { id: 'item-10', name: 'Boussole', weight: 50, brand: 'Silva', category: 'Navigation', tags: ['orientation'], capacity: 'N/A', imageUrl: 'https://placehold.co/50x50/ffddcc/ffffff?text=Boussole', isConsumable: false, packIds: [], packed: false }
                ];
            }

            if (storedPacks && JSON.parse(storedPacks).length > 0) { // Check if packs exist and are not empty
                packs = JSON.parse(storedPacks);
            } else {
                // Pre-fill with example packs
                packs = [
                    { id: 'pack-trek-ete', name: 'Pack Trek Été' },
                    { id: 'pack-weekend-ski', name: 'Pack Week-end Ski' },
                    { id: 'pack-camping-base', name: 'Pack Camping Base' }
                ];

                // Assign some initial items to packs
                if(items.find(item => item.id === 'item-1')) items.find(item => item.id === 'item-1').packIds.push('pack-trek-ete', 'pack-camping-base'); // Tente 2P
                if(items.find(item => item.id === 'item-2')) items.find(item => item.id === 'item-2').packIds.push('pack-trek-ete'); // Sac de couchage
                if(items.find(item => item.id === 'item-3')) items.find(item => item.id === 'item-3').packIds.push('pack-trek-ete', 'pack-camping-base'); // Réchaud
                if(items.find(item => item.id === 'item-4')) items.find(item => item.id === 'item-4').packIds.push('pack-trek-ete'); // Popote
                if(items.find(item => item.id === 'item-5')) items.find(item => item.id === 'item-5').packIds.push('pack-trek-ete', 'pack-weekend-ski'); // Veste Pluie
                if(items.find(item => item.id === 'item-6')) items.find(item => item.id === 'item-6').packIds.push('pack-trek-ete', 'pack-camping-base', 'pack-weekend-ski'); // Frontale
                if(items.find(item => item.id === 'item-9')) items.find(item => item.id === 'item-9').packIds.push('pack-trek-ete'); // Barres énergétiques

                // Mark some items as packed
                if(items.find(item => item.id === 'item-1')) items.find(item => item.id === 'item-1').packed = true;
                if(items.find(item => item.id === 'item-3')) items.find(item => item.id === 'item-3').packed = true;
                if(items.find(item => item.id === 'item-6')) items.find(item => item.id === 'item-6').packed = true;
            }

            if (storedCategories && JSON.parse(storedCategories).length > 0) { // Check if categories exist and are not empty
                 categories = JSON.parse(storedCategories); // Parse loaded categories
            } else {
                 // Pre-fill with example categories
                 categories = [
                     { name: 'Camping' },
                     { name: 'Cuisine' },
                     { name: 'Vêtements' },
                     { name: 'Électronique' },
                     { name: 'Hygiène' },
                     { name: 'Sécurité' },
                     { name: 'Nourriture' },
                     { name: 'Navigation' }
                 ];
            }


             renderAll(); // Render everything on load
        }

        // Function to render the pack list and update the pack select dropdowns
        function renderPacks() {
            packListElement.innerHTML = '';

            if (packs.length === 0) {
                packListElement.innerHTML = '<li class="text-center text-gray-500">Aucun pack créé.</li>';
            } else {
                 packs.forEach(pack => {
                    // Calculate weight for items whose packIds array includes this pack's ID
                    const packItems = items.filter(item => item.packIds && item.packIds.includes(pack.id));
                    const packWeight = packItems.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                    const packedWeight = packItems.filter(item => item.packed).reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0); // Calculate packed weight
                    const packProgress = packWeight > 0 ? (packedWeight / packWeight) * 100 : 0; // Progress based on weight

                    const listItem = document.createElement('li');
                    listItem.classList.add('pack-item');
                     // Add 'packed' class if all items in pack are packed (based on weight)
                     if (packWeight > 0 && packedWeight === packWeight) {
                         listItem.classList.add('packed');
                     }
                     listItem.innerHTML = `
                        <div class="weight-bar" style="width: ${packProgress}%;"></div>
                        <div class="pack-details">
                            <span class="pack-name">${pack.name}</span>
                            <span class="pack-weight">(${packWeight} g)</span>
                             <span class="ml-2 text-sm text-gray-600">${packedWeight} g / ${packWeight} g emballés</span>
                        </div>
                        <div class="pack-actions">
                             <button class="view-pack-button" data-pack-id="${pack.id}">Gérer</button> <button class="delete-button" data-pack-id="${pack.id}">Supprimer</button>
                        </div>
                    `;
                    packListElement.appendChild(listItem);

                    // Pack select dropdowns are now handled differently on the pack detail page
                });
            }

             // Add pack view options to the filter select
             updateViewFilterOptions();
        }

        // Function to render the item list based on the current view
        function renderItems(filteredItems = items) {
            itemListElement.innerHTML = ''; // Clear current list
            let totalWeight = 0;

            if (filteredItems.length === 0) {
                itemListElement.innerHTML = '<li class="text-center text-gray-500">Aucun item à afficher.</li>';
            } else {
                 filteredItems.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('item');
                    if (item.packed) {
                        listItem.classList.add('packed');
                    }

                    // Calculate item weight percentage for the bar graph (relative to total weight)
                    const itemWeight = parseFloat(item.weight) || 0;
                    const total = items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                    // For individual items, the bar represents their weight relative to the total inventory weight
                    const weightPercentage = total > 0 ? (itemWeight / total) * 100 : 0;


                    listItem.innerHTML = `
                        <div class="weight-bar" style="width: ${weightPercentage}%;"></div>
                        <div class="item-details">
                            <img src="${item.imageUrl || 'https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img'}"
                                 onerror="this.onerror=null;this.src='https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img';"
                                 alt="Image de ${item.name}"
                                 class="w-12 h-12 rounded-full object-cover mr-4 border border-gray-300">
                            <span class="item-name">${item.name}</span>
                            <span class="item-weight">(${item.weight} g)</span>
                            ${item.brand ? `<span class="item-brand">| ${item.brand}</span>` : ''}
                            ${item.category ? `<span class="item-category">| ${item.category}</span>` : ''}
                            ${item.tags && item.tags.length > 0 ? `<span class="item-tags">| Tags: ${item.tags.join(', ')}</span>` : ''}
                             ${item.capacity ? `<span class="item-capacity">| Capacité: ${item.capacity}</span>` : ''}
                             ${item.isConsumable ? `<span class="item-consumable">| Consommable</span>` : ''}
                        </div>
                        <div class="item-actions">
                             <button class="edit-button" data-item-id="${item.id}">Modifier</button>
                            </div>
                    `;
                    // Removed pack/unpack button from inventory view


                    itemListElement.appendChild(listItem);

                    // Add weight to total if it's a valid number
                    totalWeight += itemWeight;
                });
            }


            // Update total weight display
            totalWeightElement.textContent = `Poids Total : ${totalWeight} g`;
            // Update inventory weight in sidebar
            inventoryWeightElement.textContent = `(${totalWeight} g)`;


            // Save data
            saveData();
        }

        // Function to render items grouped by category (used in Inventory view filter)
        function renderCategories() {
             itemListElement.innerHTML = ''; // Clear current list
             // Get unique categories with items, including items with no category
             const categoriesWithItems = [...new Set(items.map(item => item.category || 'Sans catégorie'))];

             if (categoriesWithItems.length === 0) {
                 itemListElement.innerHTML = '<li class="text-center text-gray-500">Aucune catégorie avec des items.</li>';
             } else {
                 categoriesWithItems.forEach(category => {
                    const itemsInCategory = items.filter(item => (item.category || 'Sans catégorie') === category);
                    const categoryWeight = itemsInCategory.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                    const packedWeightInCategory = itemsInCategory.filter(item => item.packed).reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0); // Calculate packed weight in category
                     const categoryProgress = categoryWeight > 0 ? (packedWeightInCategory / categoryWeight) * 100 : 0; // Progress based on weight


                    const categoryHeader = document.createElement('li');
                    categoryHeader.classList.add('category-item', 'font-bold', 'mt-4');
                     // Add 'packed' class if all items in category are packed (based on weight)
                     if (categoryWeight > 0 && packedWeightInCategory === categoryWeight) {
                         categoryHeader.classList.add('packed');
                     }
                     categoryHeader.innerHTML = `
                        <div class="weight-bar" style="width: ${categoryProgress}%;"></div>
                         <div class="category-details">
                            <span class="category-name">${category}</span>
                            <span class="category-weight">(${categoryWeight} g)</span>
                            <span class="ml-2 text-sm text-gray-600">${packedWeightInCategory} g / ${categoryWeight} g emballés</span>
                         </div>
                         <div class="category-actions">
                             </div>
                     `;
                    itemListElement.appendChild(categoryHeader);

                    // Render items within this category
                    itemsInCategory.forEach(item => {
                         const listItem = document.createElement('li');
                         listItem.classList.add('item', 'ml-4'); // Indent items
                         if (item.packed) {
                             listItem.classList.add('packed');
                         }

                        // For items within a category view, the bar represents their weight relative to the category weight
                        const itemWeight = parseFloat(item.weight) || 0;
                        const weightPercentage = categoryWeight > 0 ? (itemWeight / categoryWeight) * 100 : 0;

                         listItem.innerHTML = `
                             <div class="weight-bar" style="width: ${weightPercentage}%;"></div>
                             <div class="item-details">
                                 <img src="${item.imageUrl || 'https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img'}"
                                      onerror="this.onerror=null;this.src='https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img';"
                                      alt="Image de ${item.name}"
                                      class="w-12 h-12 rounded-full object-cover mr-4 border border-gray-300">
                                 <span class="item-name">${item.name}</span>
                                 <span class="item-weight">(${item.weight} g)</span>
                                 ${item.brand ? `<span class="item-brand">| ${item.brand}</span>` : ''}
                                 ${item.category ? `<span class="item-category">| ${item.category}</span>` : ''}
                                 ${item.tags && item.tags.length > 0 ? `<span class="item-tags">| Tags: ${item.tags.join(', ')}</span>` : ''}
                                  ${item.capacity ? `<span class="item-capacity">| Capacité: ${item.capacity}</span>` : ''}
                                  ${item.isConsumable ? `<span class="item-consumable">| Consommable</span>` : ''}
                             </div>
                             <div class="item-actions">
                                  <button class="edit-button" data-item-id="${item.id}">Modifier</button>
                                 </div>
                         `;
                         // Removed pack/unpack button from category view
                         itemListElement.appendChild(listItem);
                    });
                 });
             }

             // Update total weight display (still show total backpack weight)
             const totalWeight = items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
             totalWeightElement.textContent = `Poids Total : ${totalWeight} g`;
             inventoryWeightElement.textContent = `(${totalWeight} g)`;


             // Save data
             saveData();
        }

        // Function to render the category management list (explicitly created categories)
        function renderCategoryManagement() {
            categoryManagementListElement.innerHTML = ''; // Clear current list

            if (categories.length === 0) {
                categoryManagementListElement.innerHTML = '<li class="text-center text-gray-500">Aucune catégorie créée. Utilisez le champ ci-dessus pour en ajouter.</li>';
            } else {
                categories.forEach(category => {
                    // Find items assigned to this explicit category
                    const itemsInCategory = items.filter(item => item.category === category.name);
                    const itemCount = itemsInCategory.length;

                    const categoryHeader = document.createElement('li');
                    categoryHeader.classList.add('category-header');
                    categoryHeader.dataset.categoryName = category.name; // Store category name for delegation
                    categoryHeader.innerHTML = `
                        <span class="category-name">${category.name || 'Sans catégorie'}</span>
                        <span class="category-item-count">(${itemCount} items)</span>
                        <i class="fas fa-chevron-down ml-2 transform transition-transform duration-200"></i>
                         <button class="delete-button ml-4" data-category-name="${category.name}">Supprimer</button> `;
                    categoryManagementListElement.appendChild(categoryHeader);

                    const categoryContent = document.createElement('ul');
                    categoryContent.classList.add('category-content');
                    categoryContent.dataset.category = category.name; // Store category name for delegation
                    categoryManagementListElement.appendChild(categoryContent);

                    // Render items within this category in the management view
                    if (itemsInCategory.length === 0) {
                         const noItemsMessage = document.createElement('li');
                         noItemsMessage.classList.add('text-center', 'text-gray-500', 'py-2');
                         noItemsMessage.textContent = 'Aucun item dans cette catégorie.';
                         categoryContent.appendChild(noItemsMessage);
                    } else {
                         itemsInCategory.forEach(item => {
                             const listItem = document.createElement('li');
                             listItem.classList.add('item'); // Use item class for styling
                              // No weight bar in this view for simplicity
                             listItem.innerHTML = `
                                 <div class="item-details">
                                     <img src="${item.imageUrl || 'https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img'}"
                                          onerror="this.onerror=null;this.src='https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img';"
                                          alt="Image de ${item.name}"
                                          class="w-12 h-12 rounded-full object-cover mr-4 border border-gray-300">
                                     <span class="item-name">${item.name}</span>
                                     <span class="item-weight">(${item.weight} g)</span>
                                     ${item.brand ? `<span class="item-brand">| ${item.brand}</span>` : ''}
                                     ${item.category ? `<span class="item-category">| ${item.category}</span>` : ''}
                                     ${item.tags && item.tags.length > 0 ? `<span class="item-tags">| Tags: ${item.tags.join(', ')}</span>` : ''}
                                      ${item.capacity ? `<span class="item-capacity">| Capacité: ${item.capacity}</span>` : ''}
                                      ${item.isConsumable ? `<span class="item-consumable">| Consommable</span>` : ''}
                                 </div>
                                 <div class="item-actions">
                                      <button class="edit-button" data-item-id="${item.id}">Modifier</button>
                                    </div>
                             `;
                              // Removed delete button from item within category management listener
                             categoryContent.appendChild(listItem);
                         });
                    }
                });
            }
             // Update the category dropdowns in forms
             updateCategoryDropdowns();
        }

        // Function to add a new category
        function addCategory() {
            console.log('addCategory function called'); // Debugging line
            const categoryName = categoryNameInput.value.trim();

            if (categoryName === '') {
                alert('Veuillez entrer le nom de la catégorie.');
                return;
            }

            // Check if category already exists (case-insensitive)
            if (categories.some(cat => cat.name.toLowerCase() === categoryName.toLowerCase())) {
                alert(`La catégorie "${categoryName}" existe déjà.`);
                return;
            }

            // Add category to the array
            categories.push({ name: categoryName });
            console.log('Categories after add:', categories); // Debugging line

            // Clear input field
            categoryNameInput.value = '';

            // Re-render category management list and update dropdowns
            renderCategoryManagement();
            saveData(); // Save data
        }

        // Function to delete a category
        function deleteCategory(categoryName) {
             // Ask for confirmation if the category contains items
             const itemsInCategory = items.filter(item => item.category === categoryName);
             if (itemsInCategory.length > 0) {
                 const confirmDelete = confirm(`La catégorie "${categoryName}" contient ${itemsInCategory.length} item(s). Voulez-vous vraiment la supprimer ? Les items ne seront pas supprimés de votre inventaire mais leur catégorie sera effacée.`);
                 if (!confirmDelete) {
                     return; // Stop if user cancels
                 }
                 // Remove the category from items that were in this category
                 items = items.map(item => {
                     if (item.category === categoryName) {
                         item.category = ''; // Clear the category
                     }
                     return item;
                 });
             } else {
                 // No items, just confirm deletion
                 const confirmDelete = confirm(`Voulez-vous vraiment supprimer la catégorie "${categoryName}" ?`);
                 if (!confirmDelete) {
                     return; // Stop if user cancels
                 }
             }

            // Filter out the category
            categories = categories.filter(cat => cat.name !== categoryName);

            // Re-render everything
            renderAll();
            saveData(); // Save data
        }


        // Function to update the category dropdowns in the forms
        function updateCategoryDropdowns() {
            const categorySelects = [newItemCategorySelect, editItemCategorySelect]; // Get references to category select elements

            categorySelects.forEach(selectElement => {
                const currentValue = selectElement.value; // Store the currently selected value

                // Clear existing options except the default one
                selectElement.innerHTML = '<option value="">-- Sélectionner une Catégorie --</option>';

                // Add categories from the 'categories' array
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    selectElement.appendChild(option);
                });

                // Reapply the stored value if it's still a valid option
                if (Array.from(selectElement.options).some(option => option.value === currentValue)) {
                    selectElement.value = currentValue;
                } else {
                    // If the old value is no longer valid (e.g., category deleted), reset to default
                    selectElement.value = '';
                }
            });
        }


        // Function to render items within a specific pack for packing view
        function renderPackPacking(packId) {
            const pack = packs.find(p => p.id === packId);
            if (!pack) return;

            packingPackNameElement.textContent = `Emballage du Pack : ${pack.name}`;
            packPackingListElement.innerHTML = '';

            // Filter items that belong to this pack
            const itemsInPack = items.filter(item => item.packIds && item.packIds.includes(packId));


            if (itemsInPack.length === 0) {
                 packPackingListElement.innerHTML = '<li class="text-center text-gray-500">Ce pack est vide.</li>';
            } else {
                 itemsInPack.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('pack-packing-item');
                    listItem.innerHTML = `
                        <span class="item-name">${item.name} (${item.weight} g)</span>
                        <input type="checkbox" data-item-id="${item.id}" ${item.packed ? 'checked' : ''}>
                    `;
                    packPackingListElement.appendChild(listItem);
                 });
            }


            packPackingModal.classList.remove('hidden'); // Show the modal
        }

        // Function to render the pack detail view
        function renderPackDetail(packId) {
             currentManagingPackId = packId; // Set the currently managed pack ID
             const pack = packs.find(p => p.id === packId);
             if (!pack) {
                 // If pack not found, maybe show pack list again or an error
                 showSection('manage-packs-section');
                 return;
             }

             packDetailTitle.textContent = `Détails du Pack : ${pack.name}`;
             itemsInPackList.innerHTML = '';
             availableItemsList.innerHTML = '';

             const itemsInThisPack = items.filter(item => item.packIds && item.packIds.includes(packId));
             // CORRECTED FILTERING LOGIC: Filter items that DO NOT have the current packId in their packIds array
             const availableItems = items.filter(item => !item.packIds || !item.packIds.includes(packId));


             const packTotalWeight = itemsInThisPack.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
             const totalInventoryWeight = items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);


             if (itemsInThisPack.length === 0) {
                 itemsInPackList.innerHTML = '<li class="text-center text-gray-500">Aucun item dans ce pack.</li>';
             } else {
                 itemsInThisPack.forEach(item => {
                     const listItem = document.createElement('li');
                     listItem.classList.add('pack-detail-item');
                      if (item.packed) {
                         listItem.classList.add('packed');
                     }

                     // Bar represents weight relative to pack total weight
                     const itemWeight = parseFloat(item.weight) || 0;
                     const weightPercentage = packTotalWeight > 0 ? (itemWeight / packTotalWeight) * 100 : 0;


                     listItem.innerHTML = `
                         <div class="weight-bar" style="width: ${weightPercentage}%;"></div>
                         <img src="${item.imageUrl || 'https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img'}"
                              onerror="this.onerror=null;this.src='https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img';"
                              alt="Image de ${item.name}"
                              class="w-10 h-10 rounded-full object-cover mr-2 border border-gray-300">
                         <span class="pack-detail-item-name">${item.name} (${item.weight} g)</span>
                         <div class="pack-detail-actions">
                              <button class="pack-item-packed-button" data-item-id="${item.id}">${item.packed ? 'Déballer' : 'Emballer'}</button> <button class="remove-from-pack-button" data-item-id="${item.id}">Retirer</button>
                         </div>
                     `;
                     itemsInPackList.appendChild(listItem);
                 });
             }

             if (availableItems.length === 0) {
                 availableItemsList.innerHTML = '<li class="text-center text-gray-500">Aucun item disponible à ajouter.</li>';
             } else {
                 availableItems.forEach(item => {
                     const listItem = document.createElement('li');
                     listItem.classList.add('pack-detail-item');

                     // Bar represents weight relative to total inventory weight
                     const itemWeight = parseFloat(item.weight) || 0;
                     const weightPercentage = totalInventoryWeight > 0 ? (itemWeight / totalInventoryWeight) * 100 : 0;


                     listItem.innerHTML = `
                         <div class="weight-bar" style="width: ${weightPercentage}%;"></div>
                         <img src="${item.imageUrl || 'https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img'}"
                              onerror="this.onerror=null;this.src='https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img';"
                              alt="Image de ${item.name}"
                              class="w-10 h-10 rounded-full object-cover mr-2 border border-gray-300">
                         <span class="pack-detail-item-name">${item.name} (${item.weight} g)</span>
                         <div class="pack-detail-actions">
                             <button class="add-to-pack-button" data-item-id="${item.id}">Ajeter</button>
                         </div>
                     `;
                     availableItemsList.appendChild(listItem);
                 });
             }

             saveData(); // Save data after rendering pack detail (in case of previous changes)
        }


        // Function to render the list based on the current view filter
        function renderListByView() {
             const selectedView = viewFilterSelect.value;
             currentView = selectedView; // Update current view state

             if (selectedView === 'all') {
                 renderItems(items); // Render all items
             } else if (selectedView === 'categories') {
                 renderCategories(); // Render grouped by category
             } else if (selectedView.startsWith('pack-')) {
                 const packId = selectedView.substring(5); // Extract pack ID
                 const itemsInPack = items.filter(item => item.packIds && item.packIds.includes(packId));
                 // For pack view, render items within that pack, and the bar represents their weight relative to the pack's total weight
                 const packTotalWeight = itemsInPack.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                 itemListElement.innerHTML = ''; // Clear current list
                 if (itemsInPack.length === 0) {
                      itemListElement.innerHTML = '<li class="text-center text-gray-500">Ce pack est vide.</li>';
                 } else {
                      itemsInPack.forEach(item => {
                         const listItem = document.createElement('li');
                         listItem.classList.add('item');
                         if (item.packed) {
                             listItem.classList.add('packed');
                         }

                         const itemWeight = parseFloat(item.weight) || 0;
                         const weightPercentage = packTotalWeight > 0 ? (itemWeight / packTotalWeight) * 100 : 0;

                          listItem.innerHTML = `
                             <div class="weight-bar" style="width: ${weightPercentage}%;"></div>
                             <div class="item-details">
                                 <img src="${item.imageUrl || 'https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img'}"
                                      onerror="this.onerror=null;this.src='https://placehold.co/50x50/eeeeee/aaaaaa?text=No+Img';"
                                      alt="Image de ${item.name}"
                                      class="w-12 h-12 rounded-full object-cover mr-4 border border-gray-300">
                                 <span class="item-name">${item.name}</span>
                                 <span class="item-weight">(${item.weight} g)</span>
                                 ${item.brand ? `<span class="item-brand">| ${item.brand}</span>` : ''}
                                 ${item.category ? `<span class="item-category">| ${item.category}</span>` : ''}
                                 ${item.tags && item.tags.length > 0 ? `<span class="item-tags">| Tags: ${item.tags.join(', ')}</span>` : ''}
                                  ${item.capacity ? `<span class="item-capacity">| Capacité: ${item.capacity}</span>` : ''}
                                  ${item.isConsumable ? `<span class="item-consumable">| Consommable</span>` : ''}
                             </div>
                             <div class="item-actions">
                                  <button class="edit-button" data-item-id="${item.id}">Modifier</button>
                                 </div>
                         `;
                         // Removed pack/unpack button from pack view in inventory section
                         itemListElement.appendChild(listItem);
                      });
                 }

                 // Update total weight display (still show total backpack weight)
                 const totalWeight = items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                 totalWeightElement.textContent = `Poids Total : ${totalWeight} g`;
                 inventoryWeightElement.textContent = `(${totalWeight} g)`;

                 saveData(); // Save data after rendering
             }
        }

        // Function to update the view filter options (add packs)
        function updateViewFilterOptions() {
             // Remove previous pack options
             viewFilterSelect.querySelectorAll('option[value^="pack-"]').forEach(option => option.remove());

             // Add current packs as view options
             packs.forEach(pack => {
                 const option = document.createElement('option');
                 option.value = `pack-${pack.id}`;
                 option.textContent = `Voir Pack : ${pack.name}`;
                 viewFilterSelect.appendChild(option);
             });

             // Ensure the current view is still valid, otherwise reset to 'all'
             const currentViewOption = viewFilterSelect.querySelector(`option[value="${currentView}"]`);
             if (!currentViewOption) {
                 currentView = 'all';
                 viewFilterSelect.value = 'all';
             }

              renderListByView(); // Re-render list based on updated view
        }


        // Function to render everything (packs, items based on current view, categories management)
        function renderAll() {
            renderPacks(); // Render packs list and update dropdown/filter
            renderListByView(); // Render items/categories/pack view in Inventory section
            renderCategoryManagement(); // Render category management list
            updateCategoryDropdowns(); // Update category dropdowns in forms
        }


        // Function to add a new item
        function addItem() {
            const name = newItemNameInput.value.trim();
            const weight = parseFloat(newItemWeightInput.value);
            const brand = newItemBrandInput.value.trim();
            const category = newItemCategorySelect.value; // Get category from select
            const tags = newItemTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            const capacity = newItemCapacityInput.value.trim();
            const imageUrl = newItemImageUrlInput.value.trim();
            const isConsumable = newItemConsumableInput.checked;
            // Pack assignment is now done on the pack detail page
            const packIds = []; // Start with an empty array of pack IDs

            // Basic validation
            if (name === '') {
                alert('Veuillez entrer le nom de l\'item.');
                return;
            }
             if (isNaN(weight) || weight < 0) {
                alert('Veuillez entrer un poids valide (nombre positif).');
                return;
            }

            // Generate a unique ID for the item
            const itemId = Date.now().toString(); // Simple timestamp based ID

            // Add item to the array
            items.push({
                id: itemId,
                name: name,
                weight: weight,
                brand: brand,
                category: category, // Use the selected category
                tags: tags,
                capacity: capacity,
                imageUrl: imageUrl,
                isConsumable: isConsumable,
                packIds: packIds, // Use the array
                packed: false // Initially not packed
            });

            // Clear input fields
            newItemNameInput.value = '';
            newItemWeightInput.value = '';
            newItemBrandInput.value = '';
            newItemCategorySelect.value = ''; // Reset select
            newItemTagsInput.value = '';
            newItemCapacityInput.value = '';
            newItemImageUrlInput.value = '';
            newItemConsumableInput.checked = false;
            newItemImagePreview.style.display = 'none'; // Hide preview after adding

            // Re-render everything
            renderAll();
        }

        // Function to add a new pack
        function addPack() {
            console.log('addPack function called'); // Debugging line
            const packName = packNameInput.value.trim();

            if (packName === '') {
                alert('Veuillez entrer le nom du pack.');
                return;
            }

            // Generate a unique ID for the pack
            const packId = `pack-${Date.now()}`; // Simple timestamp based ID

            // Add pack to the array
            packs.push({ id: packId, name: packName });
            console.log('Packs after add:', packs); // Debugging line

            // Clear input field
            packNameInput.value = '';

            // Re-render packs and update item select/view filter
            renderPacks();
             updateViewFilterOptions();
             saveData(); // Save data
        }


        // Function to toggle packed status for an item
        function togglePacked(itemId) {
            const item = items.find(item => item.id === itemId);
            if (item) {
                item.packed = !item.packed;
                 renderAll(); // Re-render everything to update status and weights
            }
        }

        // Function to toggle packed status for an item within the packing modal
         function togglePackItemPacked(itemId) {
             const item = items.find(item => item.id === itemId);
             if (item) {
                 item.packed = !item.packed;
                 saveData(); // Save immediately
                 // No need to re-render the main list, just update the checkbox state in the modal
                 // And potentially update the progress bar on the pack list if modal is closed.
             }
         }


        // Function to delete an item
        function deleteItem(itemId) {
            // Use native confirm for item deletion from inventory or category management
            const confirmDelete = confirm(`Voulez-vous vraiment supprimer l'item "${items.find(item => item.id === itemId)?.name || 'Inconnu'}" de votre inventaire ?`);
            if (!confirmDelete) {
                return; // Stop if user cancels
            }
            items = items.filter(item => item.id !== itemId); // Filter out the item
            renderAll(); // Re-render everything
            saveData(); // Save data
        }

        // Function to delete a pack
        function deletePack(packId) {
             // Ask for confirmation if the pack contains items
             const itemsInPack = items.filter(item => item.packIds && item.packIds.includes(packId));
             if (itemsInPack.length > 0) {
                 // Use native confirm for pack deletion with items
                 const confirmDelete = confirm(`Ce pack contient ${itemsInPack.length} item(s). Voulez-vous vraiment le supprimer ? Les items ne seront pas supprimés de votre inventaire mais retirés de ce pack.`);
                 if (!confirmDelete) {
                     return; // Stop if user cancels
                 }
                 // Remove packId from items that were in this pack
                 items = items.map(item => {
                     if (item.packIds && item.packIds.includes(packId)) {
                         item.packIds = item.packIds.filter(id => id !== packId); // Remove the packId
                     }
                     return item;
                 });
             } else {
                 // No items, just confirm deletion
                 const confirmDelete = confirm(`Voulez-vous vraiment supprimer le pack "${packs.find(p => p.id === packId)?.name || 'Inconnu'}" ?`);
                 if (!confirmDelete) {
                     return; // Stop if user cancels
                 }
             }

            packs = packs.filter(pack => pack.id !== packId); // Filter out the pack
            renderAll(); // Re-render everything
            saveData(); // Save data
        }

        // Function to add an item to a pack
        function addItemToPack(itemId, packId) {
            const item = items.find(item => item.id === itemId);
            if (item && item.packIds && !item.packIds.includes(packId)) {
                item.packIds.push(packId); // Add pack ID to the array
                renderPackDetail(packId); // Re-render pack detail page
                renderAll(); // Re-render everything to update weights/progress
                saveData(); // Save data
            }
        }

        // Function to remove an item from a pack
        function removeItemFromPack(itemId, packId) {
             const item = items.find(item => item.id === itemId);
             if (item && item.packIds && item.packIds.includes(packId)) {
                 item.packIds = item.packIds.filter(id => id !== packId); // Remove pack ID from the array
                 item.packed = false; // Ensure item is unpacked when removed from pack
                 renderPackDetail(packId); // Re-render pack detail page
                 renderAll(); // Re-render everything to update weights/progress
                 saveData(); // Save data
             }
        }


        // Function to show a specific content section and hide others
        function showSection(sectionId) {
            console.log('showSection called with:', sectionId); // Debug log
            contentSections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                    console.log(`Section ${section.id} set to active.`); // Debug log
                } else {
                    section.classList.remove('active');
                }
            });

            // Update active class on sidebar links
            sidebarLinks.forEach(link => {
                const linkTargetSectionId = link.dataset.section + '-section'; // Correctly form the ID from data-section
                console.log(`Checking link: ${link.dataset.section}, target: ${linkTargetSectionId}, current active: ${sectionId}`); // Debug log

                if (linkTargetSectionId === sectionId ||
                    (link.dataset.section === 'manage-packs' && sectionId === 'pack-detail-section')
                ) {
                     link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

             // Perform specific rendering based on the section shown
             if (sectionId === 'inventory-section') {
                 renderListByView();
             } else if (sectionId === 'new-item-section') {
                 updateCategoryDropdowns(); // Ensure dropdown is populated when showing this section
                 updateImagePreview(newItemImageUrlInput.value, newItemImagePreview); // Update preview when showing new item form
             } else if (sectionId === 'manage-packs-section') {
                 renderPacks(); // Ensure pack list is up-to-date
             } else if (sectionId === 'pack-detail-section' && currentManagingPackId) {
                 renderPackDetail(currentManagingPackId); // Render the details of the currently managed pack
             } else if (sectionId === 'manage-categories-section') {
                 renderCategoryManagement(); // Render the category management page
             } else if (sectionId === 'generate-pack-section') {
                 // Reset the content of the generated items list and ensure message is shown
                 generatedItemsListElement.innerHTML = '<li class="text-center text-gray-500">Aucune suggestion d\'item générée. Veuillez utiliser le formulaire ci-dessus.</li>';
                 generatedPackResultsDiv.classList.remove('hidden'); // Ensure results div is visible
             }
        }

        // Function to open the edit item modal and populate it
        function openEditModal(itemId) {
            const itemToEdit = items.find(item => item.id === itemId);
            if (!itemToEdit) return;

            // Populate the edit form fields
            editItemNameInput.value = itemToEdit.name;
            editItemWeightInput.value = itemToEdit.weight;
            editItemBrandInput.value = itemToEdit.brand;
            editItemCategorySelect.value = itemToEdit.category; // Set selected value in select
            editItemTagsInput.value = itemToEdit.tags ? itemToEdit.tags.join(', ') : ''; // Join tags array for input
            editItemCapacityInput.value = itemToEdit.capacity;
            editItemImageUrlInput.value = itemToEdit.imageUrl;
            editItemConsumableInput.checked = itemToEdit.isConsumable;

            // Store the ID of the item being edited
            editingItemIdInput.value = itemId;

            // Ensure category dropdown is populated before showing modal
            updateCategoryDropdowns();
            updateImagePreview(itemToEdit.imageUrl, editItemImagePreview); // Update preview when opening edit modal

            // Hide loading indicator
            editItemLoadingIndicator.classList.add('hidden');

            // Show the modal
            editItemModal.style.display = 'block';
        }

        // Function to save the edited item
        function saveEditedItem() {
            const itemId = editingItemIdInput.value;
            const itemIndex = items.findIndex(item => item.id === itemId);

            if (itemIndex === -1) {
                alert('Item not found.'); // Should not happen if modal is opened correctly
                return;
            }

            // Get updated values from the edit form
            const updatedName = editItemNameInput.value.trim();
            const updatedWeight = parseFloat(editItemWeightInput.value);
            const updatedBrand = editItemBrandInput.value.trim();
            const updatedCategory = editItemCategorySelect.value; // Get category from select
            const updatedTags = editItemTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            const updatedCapacity = editItemCapacityInput.value.trim();
            const updatedImageUrl = editItemImageUrlInput.value.trim();
            const updatedIsConsumable = editItemConsumableInput.checked;

             // Basic validation
            if (updatedName === '') {
                alert('Veuillez entrer le nom de l\'item.');
                return;
            }
             if (isNaN(updatedWeight) || updatedWeight < 0) {
                alert('Veuillez entrer un poids valide (nombre positif).');
                return;
            }


            // Update the item in the array
            items[itemIndex] = {
                ...items[itemIndex], // Keep existing properties like 'packed' and 'packIds'
                id: itemId, // Ensure ID is kept
                name: updatedName,
                weight: updatedWeight,
                brand: updatedBrand,
                category: updatedCategory, // Update category
                tags: updatedTags,
                capacity: updatedCapacity,
                imageUrl: updatedImageUrl,
                isConsumable: updatedIsConsumable
                // packIds are not modified here
            };

            // Close the modal
            editItemModal.style.display = 'none';
            editItemImagePreview.style.display = 'none'; // Hide preview after saving

            // Re-render everything to reflect changes
            renderAll();
             // If currently on pack detail page, re-render it
             if (currentManagingPackId && document.getElementById('pack-detail-section').classList.contains('active')) {
                 renderPackDetail(currentManagingPackId);
             }
             // If currently on category management page, re-render it
             if (document.getElementById('manage-categories-section').classList.contains('active')) {
                 renderCategoryManagement();
             }
             saveData(); // Save data
        }

        // Function to close the edit item modal
        function closeEditModal() {
            editItemModal.style.display = 'none';
            editItemImagePreview.style.display = 'none'; // Hide preview when closing modal
        }

         // Function to toggle packed status for an item specifically on the pack detail page
        function togglePackItemPackedOnDetailPage(itemId) {
            const item = items.find(item => item.id === itemId);
            if (item && currentManagingPackId) {
                item.packed = !item.packed;
                saveData(); // Save immediately
                renderPackDetail(currentManagingPackId); // Re-render the pack detail page
                renderAll(); // Re-render everything to update pack progress bars
            }
        }

        // Function to unpack all items in the current pack
        function unpackAllInCurrentPack() {
            console.log(`Déclenchement de la fonction unpackAllInCurrentPack pour le pack ID: ${currentManagingPackId}`);
            if (currentManagingPackId) {
                const itemsInPack = items.filter(item => item.packIds && item.packIds.includes(currentManagingPackId));
                console.log(`Nombre d'items dans le pack: ${itemsInPack.length}`);
                if (itemsInPack.length > 0) {
                    // Direct action without confirmation modal
                    console.log("Déballage des items...");
                    itemsInPack.forEach(item => {
                        item.packed = false; // Set packed status to false
                         console.log(`Item déballé: ${item.name} (ID: ${item.id})`);
                    });
                    saveData(); // Save changes
                    console.log("Données sauvegardées.");
                    renderPackDetail(currentManagingPackId); // Re-render pack detail page
                    renderAll(); // Re-render everything to update pack progress bars
                    console.log("Affichage mis à jour.");
                } else {
                     alert("Ce pack est déjà vide ou ne contient pas d'items à déballer.");
                     console.log("Pack vide ou aucun item à déballer.");
                }
            } else {
                 console.log("Aucun pack actuellement géré.");
            }
        }

        /**
         * Calls the Gemini API to generate content with a specific prompt and optional schema.
         * @param {string} prompt The text prompt for the LLM.
         * @param {object|null} schema An optional JSON schema for structured responses.
         * @returns {Promise<any>} The parsed JSON response from the LLM.
         */
        async function callGeminiAPI(prompt, schema = null) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory
            };

            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            const apiKey = ""; // Canvas will provide this in runtime. Do not add API key here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('API Error:', errorBody);
                    throw new Error(`API request failed with status ${response.status}: ${JSON.stringify(errorBody)}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    if (schema) {
                        return JSON.parse(text); // Parse JSON if schema was used
                    }
                    return text; // Return raw text if no schema
                } else {
                    console.warn('Unexpected API response structure:', result);
                    throw new Error('Unexpected API response structure or no content.');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                alert('Erreur lors de l\'appel à l\'IA : ' + error.message);
                return null;
            }
        }

        /**
         * Calls the Imagen API to generate an image.
         * @param {string} prompt The text prompt for the image generation.
         * @returns {Promise<string|null>} A base64 encoded image URL or null on error.
         */
        async function callImagenAPI(prompt) {
            const imagePayload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1} };
            const apiKey = ""; // Canvas will provide this in runtime.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(imagePayload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('Image API Error:', errorBody);
                    throw new Error(`Image API request failed with status ${response.status}: ${JSON.stringify(errorBody)}`);
                }

                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.warn('Unexpected Image API response structure:', result);
                    return null;
                }
            } catch (error) {
                console.error('Error calling Imagen API:', error);
                return null;
            }
        }

        /**
         * Updates the source of an image preview element.
         * If the URL is empty, the image preview is hidden.
         * If the image fails to load, it falls back to a placeholder.
         * @param {string} url The URL for the image.
         * @param {HTMLImageElement} imgElement The <img> element to update.
         */
        function updateImagePreview(url, imgElement) {
            if (url && url.trim() !== '') {
                imgElement.src = url;
                imgElement.style.display = 'block'; // Show the image
            } else {
                imgElement.src = 'https://placehold.co/80x80/eeeeee/aaaaaa?text=Image'; // Fallback to a generic placeholder
                imgElement.style.display = 'none'; // Hide if no URL
            }
        }

        // LLM Feature 1: Suggest Item Details - Now with image generation
        async function suggestItemDetails(itemName, itemBrand, targetInputFields) {
            if (!itemName) {
                alert("Veuillez entrer le nom de l'item pour obtenir des suggestions.");
                return;
            }

            const loadingIndicator = targetInputFields === 'new' ? newItemLoadingIndicator : editItemLoadingIndicator;
            const itemWeightInput = targetInputFields === 'new' ? newItemWeightInput : editItemWeightInput;
            const categorySelect = targetInputFields === 'new' ? newItemCategorySelect : editItemCategorySelect;
            const imageUrlInput = targetInputFields === 'new' ? newItemImageUrlInput : editItemImageUrlInput;
            const imagePreview = targetInputFields === 'new' ? newItemImagePreview : editItemImagePreview;


            loadingIndicator.classList.remove('hidden');
            // Disable relevant input fields during API call
            newItemNameInput.disabled = true;
            newItemBrandInput.disabled = true;
            newItemCategorySelect.disabled = true;
            newItemWeightInput.disabled = true;
            newItemImageUrlInput.disabled = true;
            editItemNameInput.disabled = true;
            editItemBrandInput.disabled = true;
            editItemCategorySelect.disabled = true;
            editItemWeightInput.disabled = true;
            editItemImageUrlInput.disabled = true;

            let suggestedCategory = 'Divers'; // Default
            let estimatedWeight = 0; // Default
            let generatedImageUrl = ''; // Default

            // --- Part 1: Text Generation (Category, Weight) ---
            const textPrompt = `Given an item named "${itemName}" and brand "${itemBrand || 'N/A'}", suggest a suitable category and an estimated realistic weight in grams. Provide the response as a JSON object with 'suggestedCategory' (string) and 'estimated_weight_grams' (number). The category should be a single word. Example: {"suggestedCategory": "Camping", "estimated_weight_grams": 1500}. The suggested category must be one of the following, if no direct match, pick the closest one: ${categories.map(cat => cat.name).join(', ')}. If none are suitable, suggest 'Divers'.`;

            const textSchema = {
                type: "OBJECT",
                properties: {
                    "suggestedCategory": { "type": "STRING" },
                    "estimated_weight_grams": { "type": "NUMBER" }
                },
                required: ["suggestedCategory", "estimated_weight_grams"]
            };

            try {
                const textResponse = await callGeminiAPI(textPrompt, textSchema);
                if (textResponse) {
                    suggestedCategory = textResponse.suggestedCategory;
                    estimatedWeight = textResponse.estimated_weight_grams;

                    // Validate and map suggested category
                    const existingCategoryNames = categories.map(cat => cat.name.toLowerCase());
                    if (!existingCategoryNames.includes(suggestedCategory.toLowerCase())) {
                        const closestCategory = existingCategoryNames.find(catName => suggestedCategory.toLowerCase().includes(catName));
                        if (closestCategory) {
                            suggestedCategory = categories.find(cat => cat.name.toLowerCase() === closestCategory).name;
                        } else {
                            suggestedCategory = 'Divers';
                        }
                    }

                    itemWeightInput.value = estimatedWeight;
                    // IMPORTANT: Ensure 'Divers' category is added AND dropdown is updated BEFORE setting the value
                    if (suggestedCategory === 'Divers' && !categories.some(cat => cat.name === 'Divers')) {
                        categories.push({ name: 'Divers' });
                        updateCategoryDropdowns(); // Update dropdowns immediately
                        saveData();
                    }
                    categorySelect.value = suggestedCategory; // Set the value after options are guaranteed to be there
                }
            } catch (error) {
                console.error("Erreur lors de la suggestion de texte:", error);
            }

            // --- Part 2: Image Generation ---
            const imageGenerationPrompt = `Une photo claire de ${itemName} ${itemBrand ? `de la marque ${itemBrand}` : ''}, prise en studio, sur fond uni blanc.`;
            try {
                const imageUrl = await callImagenAPI(imageGenerationPrompt);
                if (imageUrl) {
                    generatedImageUrl = imageUrl;
                    imageUrlInput.value = generatedImageUrl;
                    updateImagePreview(generatedImageUrl, imagePreview); // Update the preview image
                } else {
                    // Fallback to a generic placeholder if image generation fails
                    imageUrlInput.value = `https://placehold.co/100x100/eeeeee/aaaaaa?text=${encodeURIComponent(itemName.split(' ')[0])}`;
                    updateImagePreview(imageUrlInput.value, imagePreview); // Update the preview image with fallback
                }
            } catch (error) {
                console.error("Erreur lors de la génération d'image:", error);
                imageUrlInput.value = `https://placehold.co/100x100/eeeeee/aaaaaa?text=Erreur`; // Fallback on error
                updateImagePreview(imageUrlInput.value, imagePreview); // Update the preview image with error fallback
            } finally {
                loadingIndicator.classList.add('hidden');
                // Re-enable all input fields
                newItemNameInput.disabled = false;
                newItemBrandInput.disabled = false;
                newItemCategorySelect.disabled = false;
                newItemWeightInput.disabled = false;
                newItemImageUrlInput.disabled = false;
                editItemNameInput.disabled = false;
                editItemBrandInput.disabled = false;
                editItemCategorySelect.disabled = false;
                editItemWeightInput.disabled = false;
                editItemImageUrlInput.disabled = false;
                // After all suggestions, re-render to display changes immediately
                renderAll();
            }
        }

        // LLM Feature 2: Generate Pack List - Updated to consider existing inventory
        async function generatePackList() {
            const destination = genPackDestinationInput.value.trim();
            const duration = genPackDurationInput.value;
            const activity = genPackActivityInput.value.trim();

            if (!destination || !duration || !activity) {
                generatedPackResultsDiv.classList.remove('hidden');
                generatedItemsListElement.innerHTML = '<li class="text-center text-gray-500">Veuillez remplir la destination, la durée et l\'activité pour générer une liste.</li>';
                return;
            }
            if (duration <= 0) {
                generatedPackResultsDiv.classList.remove('hidden');
                generatedItemsListElement.innerHTML = '<li class="text-center text-gray-500">La durée doit être un nombre positif.</li>';
                return;
            }

            generatePackLoadingIndicator.classList.remove('hidden');
            generatePackListButton.disabled = true;

            // Prepare existing inventory data for the prompt
            const existingInventory = items.map(item => ({
                name: item.name,
                weight: item.weight,
                category: item.category
            }));

            const inventoryPromptPart = existingInventory.length > 0
                ? `En considérant l'inventaire existant de l'utilisateur qui comprend : ${JSON.stringify(existingInventory)}. `
                : '';

            const prompt = `${inventoryPromptPart}Générez une liste d'équipement.
Le format de sortie doit être un tableau JSON d'objets. Chaque objet doit avoir "name" (chaîne de caractères), "estimated_weight_grams" (nombre, en grammes, par exemple 1500), "category" (chaîne de caractères), et un champ supplémentaire "is_existing_inventory" (booléen, vrai si l'élément provient de l'inventaire existant, faux sinon).
Respectez strictement le schéma JSON.
Suggérez entre 5 et 10 éléments essentiels pour un voyage de type "${activity}" à "${destination}" pour "${duration}" jour(s).
Priorisez les éléments de l'inventaire existant s'ils sont appropriés. Si aucun élément existant n'est approprié, suggérez un nouvel élément.
Les poids doivent être des estimations réalistes en grammes.
La catégorie doit être l'une des catégories existantes si possible : ${categories.map(cat => cat.name).join(', ')}. Si aucune catégorie existante n'est appropriée, utilisez 'Divers'.`;


            const schema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "name": { "type": "STRING" },
                        "estimated_weight_grams": { "type": "NUMBER" },
                        "category": { "type": "STRING" },
                        "is_existing_inventory": { "type": "BOOLEAN" } // New field in schema
                    },
                    required: ["name", "estimated_weight_grams", "category", "is_existing_inventory"]
                }
            };

            try {
                const response = await callGeminiAPI(prompt, schema);
                generatedItemsListElement.innerHTML = ''; // Clear previous results
                if (response && Array.isArray(response) && response.length > 0) {
                    generatedPackResultsDiv.classList.remove('hidden');
                    response.forEach(item => {
                        const listItem = document.createElement('li');
                        // Add different class for existing items for distinct styling
                        listItem.classList.add('item-suggestion', item.is_existing_inventory ? 'existing-item' : 'new-item');

                        let checkboxHtml = '';
                        if (!item.is_existing_inventory) {
                            checkboxHtml = `<input type="checkbox" class="add-generated-item-checkbox" data-name="${item.name}" data-weight="${item.estimated_weight_grams}" data-category="${item.category}">`;
                        } else {
                            // For existing items, just display a badge instead of a checkbox
                            checkboxHtml = `<span class="text-xs text-blue-700 font-semibold ml-2">(Déjà dans l'inventaire)</span>`;
                        }

                        listItem.innerHTML = `
                            <div>
                                <span class="item-name">${item.name}</span>
                                <span class="item-details">(${item.estimated_weight_grams} g) | Catégorie: ${item.category}</span>
                            </div>
                            ${checkboxHtml}
                        `;
                        generatedItemsListElement.appendChild(listItem);
                    });
                } else {
                    generatedPackResultsDiv.classList.remove('hidden');
                    generatedItemsListElement.innerHTML = '<li class="text-center text-gray-500">Aucune suggestion d\'item générée. Veuillez essayer une autre combinaison.</li>';
                }
            } finally {
                generatePackLoadingIndicator.classList.add('hidden');
                generatePackListButton.disabled = false;
            }
        }

        // Event listener to add selected generated items to inventory
        addSelectedGeneratedItemsButton.addEventListener('click', function() {
            const checkboxes = generatedItemsListElement.querySelectorAll('.add-generated-item-checkbox:checked');
            let itemsAddedCount = 0;
            checkboxes.forEach(checkbox => {
                const name = checkbox.dataset.name;
                const weight = parseFloat(checkbox.dataset.weight);
                const category = checkbox.dataset.category;

                // Only add if it's not marked as an existing item (checkbox only present for new items)
                if (name && !isNaN(weight)) {
                    // Check if category exists, if not, add it
                    if (!categories.some(cat => cat.name === category)) {
                        categories.push({ name: category });
                    }

                    // Add item to the main items array
                    items.push({
                        id: `gen-item-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`, // More unique ID
                        name: name,
                        weight: weight, // Use 'weight' property as expected by the rest of the app
                        brand: '', // No brand from LLM for now
                        category: category,
                        tags: [], // No tags from LLM for now
                        capacity: '',
                        imageUrl: '', // Will be empty for generated items as Imagen API is not used here for direct fill
                        isConsumable: false,
                        packIds: [],
                        packed: false
                    });
                    itemsAddedCount++;
                }
            });

            if (itemsAddedCount > 0) {
                alert(`${itemsAddedCount} item(s) suggéré(s) ajouté(s) à votre inventaire !`);
                renderAll(); // Re-render all lists to show new items and categories
                // Clear generated items after adding
                generatedItemsListElement.innerHTML = '<li class="text-center text-gray-500">Aucune suggestion d\'item générée. Veuillez utiliser le formulaire ci-dessus.</li>'; // Reset message
                // Optionally clear the generation inputs
                genPackDestinationInput.value = '';
                genPackDurationInput.value = '3';
                genPackActivityInput.value = '';
            } else {
                alert("Aucun item sélectionné à ajouter.");
            }
        });


        // Event listeners
        addItemButton.addEventListener('click', addItem);
        // Pass the correct input elements for the new item form
        suggestNewItemDetailsButton.addEventListener('click', () => suggestItemDetails(newItemNameInput.value, newItemBrandInput.value, 'new'));
        addPackButton.addEventListener('click', addPack);
        addCategoryButton.addEventListener('click', addCategory); // New event listener for add category button
        generatePackListButton.addEventListener('click', generatePackList);


        // Allow adding item by pressing Enter in the last input field (image URL) in the new item section
        document.querySelector('#new-item-section input[type="url"]').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                addItem();
            }
        });

         // Allow adding pack by pressing Enter in the pack name field
         packNameInput.addEventListener('keypress', function(event) {
             if (event.key === 'Enter') {
                 addPack();
             }
         });

         // Allow adding category by pressing Enter in the category name field
         categoryNameInput.addEventListener('keypress', function(event) {
             if (event.key === 'Enter') {
                 addCategory();
             }
         });

        // New: Event listeners for image URL input to update preview
        newItemImageUrlInput.addEventListener('input', () => updateImagePreview(newItemImageUrlInput.value, newItemImagePreview));
        editItemImageUrlInput.addEventListener('input', () => updateImagePreview(editItemImageUrlInput.value, editItemImagePreview));


        // Event delegation for item actions (edit, delete) within the inventory section
        document.getElementById('inventory-section').addEventListener('click', function(event) {
            const target = event.target;
            const itemId = target.dataset.itemId; // Get the item ID from data attribute

            if (target.classList.contains('edit-button')) {
                 openEditModal(itemId); // Open edit modal
            } else if (target.classList.contains('delete-button')) {
                 // Use native confirm for item deletion from inventory
                 const confirmDelete = confirm(`Voulez-vous vraiment supprimer l'item "${items.find(item => item.id === itemId)?.name || 'Inconnu'}" de votre inventaire ?`);
                 if (!confirmDelete) {
                     return; // Stop if user cancels
                 }
                deleteItem(itemId);
            }
             // Removed pack/unpack button listener from here
        });

         // Event delegation for pack actions (view/manage, delete) within the manage packs section
         document.getElementById('manage-packs-section').addEventListener('click', function(event) {
             const target = event.target;
             const packId = target.dataset.packId; // Get the pack ID from data attribute

             if (target.classList.contains('view-pack-button')) {
                 showSection('pack-detail-section'); // Show pack detail section
                 renderPackDetail(packId); // Render details for this pack
             } else if (target.classList.contains('delete-button')) {
                 deletePack(packId); // This now uses native confirm
             }
         });

         // Event delegation for adding/removing items AND packing on the pack detail page
         packDetailSection.addEventListener('click', function(event) {
             const target = event.target;
             const itemId = target.dataset.itemId; // Get the item ID

             if (target.classList.contains('add-to-pack-button') && currentManagingPackId) {
                 addItemToPack(itemId, currentManagingPackId);
             } else if (target.classList.contains('remove-from-pack-button') && currentManagingPackId) {
                 removeItemFromPack(itemId, currentManagingPackId);
             } else if (target.classList.contains('pack-item-packed-button')) { // New listener for pack/unpack on detail page
                 togglePackItemPackedOnDetailPage(itemId);
             }
         });

         // Event listener for the "Tout Déballer" button
         unpackAllButton.addEventListener('click', unpackAllInCurrentPack);


         // Event listener for the view filter select
         viewFilterSelect.addEventListener('change', renderListByView);

         // Event listener for checkboxes within the pack packing modal (event delegation) - This modal is now primarily for a quick overview/packing, not detailed pack management.
         packPackingListElement.addEventListener('change', function(event) {
             const target = event.target;
             if (target.type === 'checkbox') {
                 const itemId = target.dataset.itemId;
                 togglePackItemPacked(itemId); // This function still updates the item's packed status globally
             }
         });


         // Event listener to close the packing modal
         closePackingModalButton.addEventListener('click', function() {
             packPackingModal.classList.add('hidden'); // Hide the modal
             renderAll(); // Re-render main view to update pack progress bars and weights
         });

         // Close packing modal if clicking outside (optional)
         packPackingModal.addEventListener('click', function(event) {
             if (event.target === packPackingModal) {
                 packPackingModal.classList.add('hidden');
                 renderAll(); // Re-render main view
             }
         });

        // Event listener for the Save Item button in the edit modal
        saveItemButton.addEventListener('click', saveEditedItem);
        // Pass the correct input elements for the edit item form
        suggestEditItemDetailsButton.addEventListener('click', () => suggestItemDetails(editItemNameInput.value, editItemBrandInput.value, 'edit'));


        // Event listener to close the edit item modal
        closeEditModalButton.addEventListener('click', closeEditModal);

         // Close edit modal if clicking outside (optional)
         editItemModal.addEventListener('click', function(event) {
             if (event.target === editItemModal) {
                 closeEditModal();
             }
         });

         // Event delegation for category headers and delete buttons in category management section
         categoryManagementListElement.addEventListener('click', function(event) {
             const target = event.target;

             // Handle category header click to toggle visibility
             const categoryHeaderTarget = target.closest('.category-header');
             if (categoryHeaderTarget) {
                 const categoryContent = categoryHeaderTarget.nextElementSibling; // Get the next element (the content UL)
                 const chevronIcon = categoryHeaderTarget.querySelector('.fas'); // Get the chevron icon

                 if (categoryContent && categoryContent.classList.contains('category-content')) {
                     categoryContent.classList.toggle('is-visible');
                     chevronIcon.classList.toggle('fa-chevron-down');
                     chevronIcon.classList.toggle('fa-chevron-up');
                 }
             }

             // Handle delete button click for a category
             if (target.classList.contains('delete-button') && target.dataset.categoryName) {
                 const categoryToDelete = target.dataset.categoryName;
                 deleteCategory(categoryToDelete); // Call the delete category function
             }

             // Event delegation for item actions (edit) within the category management section
             if (target.classList.contains('edit-button')) {
                 const itemId = target.dataset.itemId;
                 openEditModal(itemId); // Open edit modal
             }
             // Removed delete button from item within category management listener
         });


         // Event listeners for sidebar navigation links
         sidebarLinks.forEach(link => {
             link.addEventListener('click', function(event) {
                 event.preventDefault(); // Prevent default link behavior
                 const sectionId = this.dataset.section + '-section'; // Get target section ID
                 console.log('Sidebar link clicked, target sectionId:', sectionId); // Debug log
                 showSection(sectionId); // Show the selected section
             });
         });


        // Load data and render everything when the page loads
        loadData();

        // Show the default section on load (Inventory)
        showSection('inventory-section');

    </script>

</body>
</html>
